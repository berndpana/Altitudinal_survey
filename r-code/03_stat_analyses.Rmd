---
title: "Survey of Ho,Phy, BN"
author: "Bernd Panassiti"
date: 'created: 20.11.2013, last modified: `r format(Sys.Date(), format="%d.%m.%Y")`'
output:
  html_document: default
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    toc: yes
    toc_depth: 5
  word_document: default
subtitle: Statistical analyses of the relationship between Phytoplasma infection/
  relative quantities and Ho traits
header-includes: \usepackage{graphicx}
---

## Introduction
This script investigates relationshipt between phytoplasma infection and relative quantities and Ho traits (body size and weight).  

2 Ansaetze:  
1. Beeinflusst das Geschlecht oder die Koerpergroesse die Durchseuchung  
phytoplasma ~ gender + body size  
2. Beeinflusst phytoplasma für ein best. Geschlecht die Größe  
body size ~ gender + phytoplasma  

Vorgehensweise:  
1. Regression mit allen Variablen: sex + phytoplasma + altitude  
2. Regression mit Variablen: sex + phytoplasma  
3. Test mit likelihood ratio test: anova(model1,model2,test="LRT")  

Information about statistcs

Literature:  
http://stats.stackexchange.com/questions/60817/significance-of-categorical-predictor-in-logistic-regression
http://stats.stackexchange.com/questions/31690/how-to-test-the-statistical-significance-for-categorical-variable-in-linear-regr

## Input data

2 dataset are used:  
* Lqpcr: incorrect Ho length data omitted  
* Wqpcr: incorrect Ho weigth data omitted  

```{r setup, include=FALSE, warning=FALSE}
library(knitr)
opts_knit$set(root.dir='../')       # definining working directory; or normalizePath('../')
opts_chunk$set(fig.align='center', # aligns all figures
                echo=FALSE,         # suppresses r-code
                message=FALSE,      # suppresses library outputs
                warning=FALSE,      # suppresses library outputs
                dev='pdf')          # pdf device
```

```{r load}
# Load settings, libraries and data
rm(list=ls(all=TRUE))
source("r-code/00_settings.R")
source("r-code/00_helper_functions.R")

library(lme4)
library("memisc") # mtable function
library("ROCR") # prediction()
library(epicalc) # auc for logistic regression, lroc function
library("PresenceAbsence")
library("MuMIn") # calculation of AICc (AIC for small samles n/k<40)
library(reshape2)
library(ggplot2)
library(lattice)
require(markdown)
library(Hmisc) # group means
library(effects) # to plot interaction
library(XLConnect) # writeWorksheetToFile
library(boot) # bootstrapping

load(file="data/hyal_altitude_workingdata.RData")

set.seed(2013) # for reproducibility
```

Scaling:
Continuous variables centered at their mean. In that case, the intercept is the value of your dependent variable when all independent variables are at their mean. 

```{r input_data_length}
# length
regDfL <- Lqpcr
regDfL$log.length <- log10(regDfL$length)
regDfL$scaled.length <- scale(regDfL$length)
regDfL$scaled.altitude <- scale(regDfL$altitude)

regDfLRq <- LqpcrRelQuant
regDfLRq$log.length <- log10(regDfLRq$length)
regDfLRq$scaled.length <- scale(regDfLRq$length)
regDfLRq$scaled.rel_quant <- scale(regDfLRq$rel_quant)
regDfLRq$log.rel_quant <- log10(regDfLRq$rel_quant+1)
regDfLRq$scaled.altitude <- scale(regDfLRq$altitude)


# weight
regDfW <- Wqpcr
regDfW$log.weight <- log10(regDfW$weight)
regDfW$scaled.weight <- scale(regDfW$weight)


regDfWRq <- WqpcrRelQuant
regDfWRq$log.weight <- log10(regDfWRq$weight)
regDfWRq$scaled.weight <- scale(regDfWRq$weight)
regDfWRq$scaled.rel_quant <- scale(regDfWRq$rel_quant)
regDfWRq$log.rel_quant <- log10(regDfWRq$rel_quant)

BnHoPhy$log.length <- log10(BnHoPhy$length)
BnHoPhy$scaled.length <- scale(BnHoPhy$length)
BnHoPhy$scaled.rel_quant <- scale(BnHoPhy$rel_quant)
BnHoPhy$log.rel_quant <- log10(BnHoPhy$rel_quant)
BnHoPhy$log.altitude <- log10(BnHoPhy$altitude)
BnHoPhy$scaled.altitude <- scale(BnHoPhy$altitude)

```



\newpage

# Body size

## Influence of phytoplasma on body size

```{r}
regDf <- regDfL
regDf$sex <- relevel(regDf$sex,ref="m")
```


### Influence of phytoplasma infection and altitude on body size

Comparison of full model with altitude and saturated model.

```{r reg_infect_altitude, include=TRUE,echo=TRUE}
model1 <- lm(log.length~sex+phytoplasma+scaled.altitude + I(scaled.altitude^2),data=regDf)
summary(model1)

model2 <- lm(log.length~sex+phytoplasma+scaled.altitude,data=regDf)
summary(model2)

anova(model1,model2,test="LRT")
```

P-Value of likelihood-ratio test is: `r NumToString(anova(model1,model2,test="LRT")[2,5])`.
The likelihood ratio test is significant. Thus, the variable "altitude" should remain in the model.


\newpage

### Influence of phytoplasma infection on body size
Comparison w/o interaction: sex and phytoplasma infection.  

```{r reg_infect_interaction, include=TRUE,echo=TRUE}
model1 <- lm(log.length~phytoplasma*sex+scaled.altitude + I(scaled.altitude^2),data=regDf)
summary(model1)
```

Interaction is not significant. Thus, interaction should not remain in the model.  

Coefficients:
                      Estimate Std. Error t value Pr(>|t|)    
(Intercept)           0.470779   0.004859  96.883  < 2e-16 ***
phytoplasma1         -0.029911   0.014179  -2.110  0.03526 *  
sexw                  0.164481   0.006225  26.424  < 2e-16 ***
scaled.altitude       0.005884   0.003399   1.731  0.08386 .  
I(scaled.altitude^2) -0.004339   0.001473  -2.945  0.00334 ** 
phytoplasma1:sexw     0.019699   0.017808   1.106  0.26901    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.07552 on 685 degrees of freedom
Multiple R-squared:  0.5473,  Adjusted R-squared:  0.544 
F-statistic: 165.6 on 5 and 685 DF,  p-value: < 2.2e-16


\newpage

Plot visualizes ineraction. Non-parallel lines indicate interaction.  
```{r}
plot(effect("phytoplasma:sex", model1), multiline = TRUE)
```


```{r reg_infect, include=TRUE,echo=TRUE}
# choose reference categories
regDf$sex <- relevel(regDf$sex,ref="m")
regDf$phytoplasma <- relevel(regDf$phytoplasma,ref="0")
model1 <- lm(log.length~sex+phytoplasma+scaled.altitude + I(scaled.altitude^2),data=regDf)
summary(model1)
```

Influence of phytoplasma infection on Ho body size is significant.

Coefficients:
                      Estimate Std. Error t value Pr(>|t|)    
(Intercept)           0.469476   0.004715  99.567  < 2e-16 ***
sexw                  0.166860   0.005842  28.561  < 2e-16 ***
phytoplasma1         -0.017414   0.008569  -2.032  0.04253 *  
scaled.altitude       0.005701   0.003395   1.679  0.09358 .  
I(scaled.altitude^2) -0.004381   0.001473  -2.974  0.00304 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.07553 on 686 degrees of freedom
Multiple R-squared:  0.5465,  Adjusted R-squared:  0.5439 
F-statistic: 206.7 on 4 and 686 DF,  p-value: < 2.2e-16




4 different plots using ggplot

```{r}
RegY <- function(sex=0,phy=0,x){
  
  Y <- 0.469476+0.16686*sex+(-0.017414*phy)+(0.0057011*x)+(-0.004381*(x^2))
  return(Y)
}
# e.g. rbind(seq(-1,4,length.out=4),RegY(sex=1,phy=0.5,seq(-1,4,length.out=4)))

df <- regDf
df$scaled.altitude <- as.vector(df$scaled.altitude)
df$scaled.altitude.sq <- df$scaled.altitude*df$scaled.altitude
model1 <- lm(log.length~sex+phytoplasma+scaled.altitude+scaled.altitude.sq,data=df)
summary(model1)

# create newdata to allow lines for entire range of altitude
newdata <- with(df, data.frame(
  scaled.altitude = rep(seq(from = -2, to = 5, length.out = 50), 4),
  phytoplasma = factor(rep(c("0","0","1","1"), each = 50)),
  sex = factor(rep(c("m","w","m","w"), each = 50))))
newdata$scaled.altitude.sq <- newdata$scaled.altitude*newdata$scaled.altitude
newdata$log.length.preds <- stats::predict(model1, newdata=newdata)



ggplot(aes(x=scaled.altitude, y=log.length), data=regDf) +
  theme_bw()+
  geom_point(aes(x=scaled.altitude, y=log.length,color= phytoplasma,shape=sex),data=regDf)+
  facet_grid(sex ~ phytoplasma)+
  geom_line(aes(x=scaled.altitude, y=log.length.preds),data=newdata,color="black")+
  scale_colour_manual('phytoplasma', values = c('1' = 'black', '0' = 'grey80')) +
  ylab(bquote(~"log"[10]~"("~italic("Hyalesthes obsoletus")~"body size (mm) )")) +# Set y-axis label
  xlab(bquote(~"Scaled altitude (m a.s.l.)"))





### ONLY for sex, mean phytoplasma

newdata <- data.frame(
scaled.altitude = rep(seq(-2,6,length.out=50),2),
sex = as.factor(rep(c("m","w"), each = 50)),
log.length.preds = c(RegY(sex=0,phy=0.5,seq(-2,6,length.out=50)),RegY(sex=1,phy=0.5,seq(-2,6,length.out=50))))


ggplot(aes(x=scaled.altitude, y=log.length), data=regDf) +
  theme_bw()+
  theme(legend.key = element_blank()) +
  geom_point(aes(x=scaled.altitude, y=log.length,color= phytoplasma,shape=sex),data=regDf)+
  facet_grid(sex ~ .)+
  geom_line(aes(x=scaled.altitude, y=log.length.preds),data=newdata,color="black")+
  scale_colour_manual('phytoplasma', values = c('1' = 'black', '0' = 'grey80')) +
  ylab(bquote(~"log"[10]~"("~italic("Hyalesthes obsoletus")~"body size (mm) )")) +# Set y-axis label
  xlab(bquote(~"Scaled altitude (m a.s.l.)"))
 
  
  
  
########
ggplot(data=regDf, aes(x=phytoplasma, y=log.length)) + 
   theme_bw()+
  geom_point() +
   facet_grid(~sex) +
   geom_smooth(method = "lm",size = 1, se=FALSE, color="black", aes(group=1)) + 
  ylab(bquote(~"log"[10]~"("~italic("Hyalesthes obsoletus")~"body size (mm) )")) +# Set y-axis label
  xlab(bquote(~"Scaled altitude (m a.s.l.)"))
  #xlab(bquote(italic("Hyalesthes obsoletus")~"infected with"~italic("Ca.")~"Phytoplasma solani")) + # Set x-axis label


ggplot(data=regDf, aes(x=phytoplasma, y=log.length)) + 
   theme_bw()+
  geom_boxplot(aes(colour = sex)) + 
  geom_smooth(method = "lm",size = 1, se=FALSE, aes(group=sex,color=sex)) +
  scale_colour_manual('sex', values = c('m' = 'black', 'w' = 'grey80')) +
  ylab(bquote(~"log"[10]~"("~italic("Hyalesthes obsoletus")~"body size (mm) )")) + # Set y-axis label
  xlab(bquote(italic("Hyalesthes obsoletus")~"infected with"~italic("Ca.")~"Phytoplasma solani")) # Set x-axis label
```

> summary(lm(log.length~sex+phytoplasma-1,data=regDf))

Call:
lm(formula = log.length ~ sex + phytoplasma - 1, data = regDf)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.21774 -0.04799 -0.01127  0.06024  0.18672 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
sexm          0.465529   0.004533 102.700   <2e-16 ***
sexw          0.632001   0.004006 157.774   <2e-16 ***
phytoplasma1 -0.018978   0.008592  -2.209   0.0275 *  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.07591 on 688 degrees of freedom
Multiple R-squared:  0.9823,  Adjusted R-squared:  0.9823 
F-statistic: 1.276e+04 on 3 and 688 DF,  p-value: < 2.2e-16


Interaction nicht significant. Auch wenn bei ggplot 2




```{r tabulation_group_means}
# calculation of means in subgroups; library Hmisc
summary(log.length~sex+phytoplasma+altitude,data=regDf, method = "cross", fun = mean) 
```


\newpage








## Influence of rel. quantity on body size


```{r}
regDf <- regDfLRq
regDf$sex <- relevel(regDf$sex,ref="m")
```


### Influence of rel. quantity and altitude on body size

Comparison of full model with altitude and saturated model.

```{r reg_rel_quant_altitude, include=TRUE,echo=TRUE}
model1 <- lm(log.length~sex+scaled.rel_quant+scaled.altitude+I(scaled.altitude^2),data=regDf)
summary(model1)

model2 <- lm(log.length~sex+scaled.rel_quant+scaled.altitude,data=regDf)
summary(model2)

anova(model1,model2,test="LRT")
```



P-Value of likelihood-ratio test is: `r NumToString(anova(model1,model2,test="LRT")[2,5])`.
The likelihood ratio test is significant. Thus, the variable "altitude" should remain in the model.

\newpage

### Influence of Rel. quantity on body size
Comparison w/o interaction: sex and rel. quantity.

```{r reg_rel_quant_interaction, include=TRUE,echo=TRUE}
model1 <- lm(log.length~sex*scaled.rel_quant+scaled.altitude+I(scaled.altitude^2),data=regDf)
summary(model1)
```

Interaction is not significant. Thus, interaction should not remain in the model


```{r reg_rel_quant, include=TRUE,echo=TRUE}
model1 <- lm(log.length~sex+scaled.rel_quant+scaled.altitude+I(scaled.altitude^2),data=regDf)
summary(model1)
```

Influence of phytoplasma relative quantity on Ho body size on is not significant.

Coefficients:
                      Estimate Std. Error t value Pr(>|t|)    
(Intercept)           0.468154   0.004648 100.712  < 2e-16 ***
sexw                  0.165679   0.005853  28.308  < 2e-16 ***
scaled.rel_quant     -0.004681   0.002887  -1.622  0.10536    
scaled.altitude       0.006259   0.003394   1.844  0.06563 .  
I(scaled.altitude^2) -0.004647   0.001473  -3.155  0.00168 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.07562 on 686 degrees of freedom
Multiple R-squared:  0.5455,  Adjusted R-squared:  0.5429 
F-statistic: 205.9 on 4 and 686 DF,  p-value: < 2.2e-16





```{r}
ggplot(data=regDf, aes(x=scaled.rel_quant, y=log.length, group=sex, shape=sex,linetype=sex)) +  
  theme_bw() +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE, color="black") + 
  xlab(bquote("Scaled relative quantities of "~italic("Ca.")~"Phytoplasma solani")) + # Set x-axis label
  ylab(bquote(~"log"[10]~"("~italic("Hyalesthes obsoletus")~"body size (mm))")) # Set y-axis label

```



\newpage


# Weight

## Influence of phytoplasma on body size

```{r}
regDf <- regDfW
regDf$sex <- relevel(regDf$sex,ref="m")
```


### Influence of phytoplasma infection and altitude on body size

Comparison of full model with altitude and saturated model.

```{r reg_infect_altitude, include=TRUE,echo=TRUE}
model1 <- lm(log.weight~sex+phytoplasma+altitude+I(altitude^2),data=regDf)
summary(model1)

model2 <- lm(log.weight~sex+phytoplasma+altitude,data=regDf)
summary(model2)

anova(model1,model2,test="LRT")
```

P-Value of likelihood-ratio test is: `r NumToString(anova(model1,model2,test="LRT")[2,5])`.
The likelihood ratio test is not significant. Thus, the variable "altitude" should not remain in the model.


\newpage

### Influence of phytoplasma infection on body size
Comparison w/o interaction: sex and phytoplasma infection.  

```{r reg_infect_interaction, include=TRUE,echo=TRUE}
model1 <- lm(log.weight~phytoplasma*sex,data=regDf)
summary(model1)
```

Interaction is not significant. Thus, interaction should not remain in the model.  

\newpage

Plot visualizes ineraction. Non-parallel lines indicate interaction.  
```{r}
plot(effect("phytoplasma:sex", model1), multiline = TRUE)
```


```{r reg_infect, include=TRUE,echo=TRUE}
# choose reference categories
regDf$sex <- relevel(regDf$sex,ref="m")
regDf$phytoplasma <- relevel(regDf$phytoplasma,ref="0")
model1 <- lm(log.weight~sex+phytoplasma,data=regDf)
summary(model1)
```

Influence of phytoplasma infection on Ho body size is significant.

```{r}
ggplot(data=regDf, aes(x=phytoplasma, y=log.weight, group=sex, shape=sex,linetype=sex)) +  
   theme_bw()+
  geom_point() +
   geom_smooth(method = "lm", se=FALSE, color="black") + 
  xlab(bquote(italic("Hyalesthes obsoletus")~"infected with"~italic("Ca.")~"Phytoplasma solani")) + # Set x-axis label
  ylab(bquote(~"log"[10]~"("~italic("Hyalesthes obsoletus")~"weight (g))")) # Set y-axis label

```





```{r tabulation_group_means}
# calculation of means in subgroups; library Hmisc
summary(log.length~sex+phytoplasma,data=regDf, method = "cross", fun = mean) 
```


\newpage








## Influence of rel. quantity on Ho body weight


```{r}
regDf <- regDfWRq
regDf$sex <- relevel(regDf$sex,ref="m")
```


### Influence of rel. quantity and altitude on Ho body weight

Comparison of full model with altitude and saturated model.

```{r reg_rel_quant_altitude, include=TRUE,echo=TRUE}
model1 <- lm(log.weight~sex+scaled.rel_quant+altitude+I(altitude^2),data=regDf)
summary(model1)

model2 <- lm(log.weight~sex+scaled.rel_quant+altitude,data=regDf)
summary(model2)

anova(model1,model2,test="LRT")
```



```{r reg_rel_quant_altitude, include=TRUE,echo=TRUE}
model1 <- lm(log.weight~sex+scaled.rel_quant+altitude,data=regDf)
summary(model1)

model2 <- lm(log.weight~sex+scaled.rel_quant,data=regDf)
summary(model2)

anova(model1,model2,test="LRT")
```

P-Value of likelihood-ratio test is: `r NumToString(anova(model1,model2,test="LRT")[2,5])`.
The likelihood ratio test is not significant. Thus, the variable "altitude" should not remain in the model.

\newpage

### Influence of Rel. quantity on Ho body weight
Comparison w/o interaction: sex and rel. quantity.

```{r reg_rel_quant_interaction, include=TRUE,echo=TRUE}
model1 <- lm(log.weight~sex*scaled.rel_quant,data=regDf)
summary(model1)
```

Interaction is not significant. Thus, interaction should not remain in the model


```{r reg_rel_quant, include=TRUE,echo=TRUE}
model1 <- lm(log.weight~sex+scaled.rel_quant,data=regDf)
summary(model1)
```

Influence of phytoplasma relative quantity on Ho body size on is not significant.



```{r}
ggplot(data=regDf, aes(x=scaled.rel_quant, y=log.weight, group=sex, shape=sex,linetype=sex)) +  
  theme_bw() +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE, color="black") + 
  xlab(bquote("Scaled relative quantities of "~italic("Ca.")~"Phytoplasma solani")) + # Set x-axis label
  ylab(bquote(~"log"[10]~"("~italic("Hyalesthes obsoletus")~"weight (g))")) # Set y-axis label

```


# Infection


## Influence of Ho body size on phytoplasma infection

```{r}
regDf <- regDfL
regDf$sex <- relevel(regDf$sex,ref="m")
```


### Influence of Ho body size and altitude on phytoplasma infection

Comparison of full model with altitude and saturated model.


```{r reg_infect_altitude, include=TRUE,echo=TRUE}
model1 <- glm(phytoplasma~sex+scaled.length+altitude+I(altitude^2),data=regDf,family="binomial")
summary(model1)

model2 <- glm(phytoplasma~sex+scaled.length+altitude,data=regDf,family="binomial")
summary(model2)

anova(model1,model2,test="Chisq")
```


```{r reg_infect_altitude, include=TRUE,echo=TRUE}
model1 <- glm(phytoplasma~sex+scaled.length+altitude,data=regDf,family="binomial")
summary(model1)

model2 <- glm(phytoplasma~sex+scaled.length,data=regDf,family="binomial")
summary(model2)

anova(model1,model2,test="Chsiq")
```

P-Value of likelihood-ratio test is: `r NumToString(anova(model1,model2,test="Chisq")[2,5])`.
The likelihood ratio test is not significant. Thus, the variable "altitude" should not remain in the model.


\newpage

### Influence of Ho body size on phytoplasma infection
Comparison w/o interaction: sex and phytoplasma infection.  

```{r reg_infect_interaction, include=TRUE,echo=TRUE}
model1 <- glm(phytoplasma~scaled.length*sex,data=regDf,family="binomial")
summary(model1)
```

Interaction is not significant. Thus, interaction should not remain in the model.  

\newpage



```{r reg_infect, include=TRUE,echo=TRUE}
# choose reference categories
regDf$sex <- relevel(regDf$sex,ref="m")
regDf$phytoplasma <- relevel(regDf$phytoplasma,ref="0")
model1 <- glm(phytoplasma~sex+scaled.length,data=regDf,family="binomial")
summary(model1)
```


Influence of phytoplasma infection on Ho body size is significant.



```{r reg_bodysize, include=TRUE,echo=TRUE}
model1 <- glm(phytoplasma ~ sex + as.numeric(scaled.length),data=regDf,family=binomial)
summary(model1)

model2 <- glm(phytoplasma ~ sex,data=regDf,family=binomial)
summary(model2)
d2(model2)
NumToString(as.numeric(mtable(model2)$summaries[[4]]))
anova(model1, model2, test="Chisq")
```

The likelihood ratio test is highly significant and we would conclude that the variable sex should remain in the model.

Influence of phytoplasma infection on Ho body size is significant.



```{r r reg_bodysize_diagnosis}
model1 <- glm(phytoplasma ~ sex + as.numeric(scaled.length),data=regDf,family=binomial)
summary(model1)
d2(model1)
NumToString(as.numeric(mtable(model1)$summaries[[4]]))
lroc(model1)$auc
#model1.pred<-prediction(model1$fitted.values,model1$y)
#performance(model1.pred,"auc")@y.values[[1]]

mean(model1$fitted.value)
# [1] 0.130246
df <- regDf
observedDisease<-as.numeric(levels(df$phytoplasma))[df$phytoplasma]
> mean(observedDisease)
#[1] 0.130246

sum(observedDisease)
#[1] 90

set.seed(2015)
predictedDisease <- boot(data=df,statistic=bootPredict, R=1000,formula=phytoplasma~sex+as.vector(scaled.length))

pValues <- doUnivariateTest(dfObs=observedDisease,dfSim=predictedDisease$t, fun=mean)
```





```{r Reg_Inf_Bs_v1}
newdata=data.frame(sex = factor(rep(c("m","w"), each = 346)),scaled.length=rep(seq(-3,3, length.out = 346),2))
newdata <- newdata[-1,]
newdata$length <- (newdata$scaled.length+0.941)+3.74 

predicted <- predict(model1, newdata = newdata, type = "response",se = TRUE)

ggplotDf <- data.frame(cbind(newdata,predicted))
ggplot(ggplotDf, aes(x = length, y = fit)) + 
  theme_bw()+
  geom_line(aes(colour = sex), size = 1) +
  ylab(bquote(italic("Hyalesthes obsoletus")~"infected with"~italic("Ca.")~"Phytoplasma solani")) + # Set y-axis label
  xlab(bquote(~italic("Hyalesthes obsoletus")~"body size (mm)")) # Set x-axis label


# only male intercept
(1/(1+exp(-1*(model1$coefficients[[3]]*0+model1$coefficients[[2]]*0+model1$coefficients[[1]]))))
#[1] 0.2602797

# female intercept
(1/(1+exp(-1*(model1$coefficients[[3]]*0+model1$coefficients[[2]]+model1$coefficients[[1]]))))
# [1] 0.4431047





# response  <- regDf$phytoplasma
# predictor <- regDf$length
# 
# loguni.m <- glm(response~predictor,family=binomial)
# px <- seq(min(predictor),max(predictor),0.01)
# summary(loguni.m)
# plot(regDf$length,regDf$phytoplasma,ylim=c(0,0.2))
# lines(px,(1/(1+exp(-1*(loguni.m$coefficients[[2]]*px+loguni.m$coefficients[[1]])))),type="l")
# exp(coef(loguni.m))
# # > (1/(1+exp(-1*(loguni.m$coefficients[[2]]*0+loguni.m$coefficients[[1]]))))
# # [1] 0.1552624
```





```{r Reg_Inf_Bs_v2}
regDf$phytoplasma.pred <- predict(model1,type="response")

ggplot(data=regDf, aes(x=scaled.length, y=phytoplasma.pred, group=sex, shape=sex,linetype=sex)) +  
  theme_bw()+
  geom_point() +
   stat_smooth(method = "glm",family="binomial", se=FALSE, color="black",) + 
   #stat_smooth(aes(x=scaled.length, y=phytoplasma),data=regDfPredicted,stat="identity") + 
  ylab(bquote(italic("Hyalesthes obsoletus")~"infected with"~italic("Ca.")~"Phytoplasma solani")) + # Set y-axis label
  xlab(bquote(~"scaled"~italic("Hyalesthes obsoletus")~"body size (mm)")) # Set x-axis label
```



\newpage


# Rel. quantities

## Influence of rel. quantity on body size


```{r}
regDf <- regDfLRq
regDf$sex <- relevel(regDf$sex,ref="m")
```


### Influence of Ho body size and altitude on rel. quantity

Comparison of full model with altitude and saturated model.

```{r reg_rel_quant_altitude, include=TRUE,echo=TRUE}
model1 <- lm(rel_quant~sex+scaled.length+altitude+I(altitude^2),data=regDf)
summary(model1)

model2 <- lm(rel_quant~sex+scaled.length+altitude,data=regDf)
summary(model2)

anova(model1,model2,test="LRT")
```


```{r reg_rel_quant_altitude, include=TRUE,echo=TRUE}
model1 <- lm(rel_quant~sex+scaled.length+altitude,data=regDf)
summary(model1)

model2 <- lm(rel_quant~sex+scaled.length,data=regDf)
summary(model2)

anova(model1,model2,test="LRT")
```

P-Value of likelihood-ratio test is: `r NumToString(anova(model1,model2,test="LRT")[2,5])`.
The likelihood ratio test is not significant. Thus, the variable "altitude" should not remain in the model.

\newpage

### Influence of Rel. quantity on body size
Comparison w/o interaction: sex and rel. quantity.

```{r reg_rel_quant_interaction, include=TRUE,echo=TRUE}
model1 <- lm(scaled.rel_quant~sex*scaled.length,data=regDf)
summary(model1)
```

Interaction is not significant. Thus, interaction should not remain in the model


```{r reg_rel_quant_unimodal, include=TRUE,echo=TRUE}
model1 <- lm(rel_quant~sex+scaled.length+I(scaled.length^2),data=regDf)
summary(model1)
```

There is no unimodal relationship.

```{r reg_rel_quant_sex_length, include=TRUE,echo=TRUE}
model1 <- lm(log.rel_quant~scaled.length+sex,data=regDf)
summary(model1)
model2 <- lm(log.rel_quant~scaled.length,data=regDf)
summary(model2)
anova(model1,model2)
```

The variable sex does not significantly contribute.

```{r reg_rel_quant_length, include=TRUE,echo=TRUE}
model1 <- lm(log.rel_quant~scaled.length,data=regDf)
summary(model1)

```



```{r Reg_RelQuant_Bs}
# ## with sex as grouping variable
# ggplot(data=regDf, aes(x=scaled.length, y=log.rel_quant, group=sex, shape=sex,linetype=sex)) +  
#   theme_bw() +
#   geom_point() +
#   #geom_smooth(method = "lm", formula=y~x+I(x^2),se=FALSE, color="black") + 
#   geom_smooth(method = "lm",se=FALSE, color="black") + 
#   ylab(bquote(~"log"[10]~"("~"Relative quantities of "~italic("Ca.")~"Phytoplasma solani)")) + # Set x-axis label
#   xlab(bquote(~"scaled"~italic("Hyalesthes obsoletus")~"body size (mm)")) # Set y-axis label


ggplot(data=regDf, aes(x=scaled.length, y=log.rel_quant)) +  
  theme_bw() +
  geom_point(aes(x=scaled.length, y=log.rel_quant, shape=sex)) +
  #geom_smooth(method = "lm", formula=y~x+I(x^2),se=FALSE, color="black") + 
  geom_smooth(method = "lm",se=FALSE, color="black") + 
  ylab(bquote(~"log"[10]~"("~"Relative quantities of "~italic("Ca.")~"Phytoplasma solani)")) + # Set x-axis label
  xlab(bquote(~"scaled"~italic("Hyalesthes obsoletus")~"body size (mm)")) # Set y-axis label


```



\newpage




# Disease

Models are using the BnHoPhy object.

## Multivariate model

```{r}
model1 <- glm(cbind(ill,N)~sex+length+phytoplasma+altitude,data=BnHoPhy,family="binomial")
summary(model1)

model2 <- glm(cbind(ill,N)~sex+length+phytoplasma,data=BnHoPhy,family="binomial")
summary(model2)

anova(model1,model2,test="Chisq")
```

Altitude significant, should stay in model

```{r}
model1 <- glm(cbind(ill,N)~sex+length+phytoplasma+altitude,data=BnHoPhy,family="binomial")
summary(model1)


model2 <- glm(cbind(ill,N)~sex+length+altitude,data=BnHoPhy,family="binomial")
summary(model2)

anova(model1,model2,test="Chisq")
```

Phytoplasma not significant, should not stay in model.


```{r}
model1 <- glm(cbind(ill,N)~sex+length+altitude,data=BnHoPhy,family="binomial")
summary(model1)

model2 <- glm(cbind(ill,N)~sex+altitude,data=BnHoPhy,family="binomial")
summary(model2)

anova(model1,model2,test="Chisq")
```

The likelihood ratio test is highly significant and we would conclude that the variable body size should remain in the model.


```{r}
model1 <- glm(cbind(ill,N)~sex+length+altitude,data=BnHoPhy,family="binomial")
summary(model1)

model2 <- glm(cbind(ill,N)~length+altitude,data=BnHoPhy,family="binomial")
summary(model2)

anova(model1,model2,test="Chisq")
```

The likelihood ratio test is highly significant and we would conclude that the variable sex should remain in the model.



```{r}
model1 <- glm(cbind(ill,N)~scaled.length+sex*scaled.altitude,data=BnHoPhy,family="binomial")
summary(model1)
d2(model1)
```

Interaction is significant.
```{r Bn_Bs_Altitude}
model1 <- glm(cbind(ill,N-ill)~as.factor(sex)+scaled.length+scaled.altitude+I(scaled.altitude^2),data=BnHoPhy,family="binomial")
summary(model1)
d2(model1)
NumToString(as.numeric(mtable(model1)$summaries[[4]]))
length(model1$fitted.values) # how many variables


# Scaled relative quantities -> but only 7 data points
model2 <- glm(cbind(ill,N)~sex+scaled.rel_quant+altitude+I(scaled.altitude^2),data=BnHoPhy,family="binomial")
summary(model2)
d2(model2)
NumToString(as.numeric(mtable(model2)$summaries[[4]]))
length(model2$fitted.values) # how many variables

model3 <- glm(cbind(ill,N)~sex+scaled.rel_quant+altitude,data=BnHoPhy,family="binomial")
summary(model3)
d2(model3)
NumToString(as.numeric(mtable(model3)$summaries[[4]]))
length(model3$fitted.values) # how many variables

```


```{r Bn_Bs_Altitude_Diagnosis}
model1 <- glm(cbind(ill,N-ill)~as.factor(sex)+scaled.length+scaled.altitude+I(scaled.altitude^2),data=BnHoPhy,family="binomial")
summary(model1)


```{r}
d2(model1)
NumToString(as.numeric(mtable(model1)$summaries[[4]]))
length(model1$fitted.values) # how many variables

lroc(model1)$auc # library epicalc

observedDisease<-BnHoPhy$ill/BnHoPhy$N
predictedDisease <- round(predict(model1,type="response"),3) # model1$fitted.value

frequencyObs  <- table(observedDisease)  / length(observedDisease)
frequencyPred <- table(predictedDisease) / length(predictedDisease)

combined <- rbind(c(frequencyObs, rep(NA,  (length(frequencyPred) - length(frequencyObs)))), frequencyPred) # empty frequencies

par(c)
barplot(combined, beside = T)

plot(observedDisease,predictedDisease)
abline(c(0,0),c(1,1))


# residuals
sum(residuals(model1, type = "pearson")^2)

residualsPearson<-residuals(model1, type = "pearson")
plot(observedDisease,residualsPearson)
abline(c(0,0),c(1,0))

df <- BnHoPhy[,c("ill","N","sex","scaled.rel_quant","scaled.altitude")]
df <- na.omit(df)

df <- BnHoPhy
observedDisease<-df$ill/(df$N-df$ill)
set.seed(2015)
predictedDisease <- boot(data=df,statistic=bootPredict, R=1000,formula=cbind(ill,N-ill)~sex+scaled.length+scaled.altitude+I(scaled.altitude))

pValues <- doUnivariateTest(dfObs=observedDisease,dfSim=predictedDisease$t, fun=mean)
```



BnHoPhy (binomial: ill,N) needs to be untangled.
```{r}
BnHoPhyVine <- BnHoPhy[rep(seq_len(nrow(BnHoPhy)),BnHoPhy$N),] # duplicates each row N times
#repeat each binomial: ill=1,N=8 -> 1 0 0 0 0 0 0 0 
illVines <- rep(0,nrow(BnHoPhyVine))
j=1
#for(i in 1:2){
for(i in 1:nrow(BnHoPhy)){
  if(BnHoPhy$ill[i]>0) {illVines[j:(j+(BnHoPhy$ill[i]-1))] <- rep(1,BnHoPhy$ill[i])}
j=j+(BnHoPhy$N[i])
}

BnHoPhyVine$ill <- illVines
```

```{r Disease_glm_logistic}
model1 <- glm(ill~sex+scaled.length+scaled.altitude+I(scaled.altitude^2),data=BnHoPhyVine,family="binomial")
summary(model1)



model2 <- glm(cbind(ill,N-ill)~sex+scaled.length+scaled.altitude+I(scaled.altitude^2),data=BnHoPhy,family="binomial")
summary(model2)
```

```{r}
library(Hmisc)
describe(BnHoPhyVine)

test <- glm(ill~sex+phytoplasma+scaled.altitude+I(scaled.altitude^2),data=BnHoPhyVine,family="binomial")
summary(test)

test <- glm(ill~sex+scaled.rel_quant+scaled.altitude+I(scaled.altitude^2),data=BnHoPhyVine,family="binomial")
summary(test)
```


```{r Disease_glm_logistic_diagnosis_fit}
glm1<-model1
glm0 <- update(glm1,.~1) # only intercept

N <- nobs(glm1) # observations
LLf <- as.numeric(logLik(glm1)) # log-likelihood saturated model
LL0 <- as.numeric(logLik(glm0)) # log-likelihood null model
#(1-exp(-808.32/n))/(1-exp(2*as.numeric(logLik(modelIntercept)/n)))


mtable(glm1)

# AUC
lroc(model1)$auc # library epicalc
roc.area(obs=glm1$data$ill,pred=predict(glm1,type="response")) # $A = AUC, package "verification", Dormann, p.150


# Analysis of deviance
anova(glm0,glm1,test="Chisq")
#1-pchisq((anova(glm0,glm1,test="Chisq"))$Deviance[2],(anova(glm0,glm1,test="Chisq"))$Df[2])
# if p<0.05 than model fits significantly better than intercept model
# Zuur, Mixed effect models, p. 223

### Pseudo R

# Deviance, proportional increase in explained deviance
d2(model1) 
# = 1-(glm1$deviance/glm1$null.deviance), ((glm1$null.deviance-glm1$deviance)/glm1$null.deviance)
# Zuur, Mixed effect models, p. 218

1-(LLf/LL0) # McFadden 
(1-exp(2*(LL0-LLf)/N)) # Cox & Snell
(1-exp(2*(LL0-LLf)/N))/(1-exp(2*LL0/N)) # Nagelkerke
# source: www.uni-kiel.de/psychologie/rexrepos/posts/regressionLogistic
```

Results from GLM:  
- significant different from NULL model  
- AUC: 0.71  
- explained deviance: 4.8%  
- Nagelkerke R2: 0.05



```{r Disease_glm_logistic_diagnosis_residuals}
# Comparison simulalted with observed occurrences
df <- BnHoPhyVine
observedDisease<-df$ill # BnHoPhy$ill/BnHoPhy$N
predictedDisease <- round(predict(glm1,type="response"),3) # model1$fitted.value

set.seed(2015)
predictedDisease <- boot(data=df,statistic=bootPredict, R=1000,formula=ill~sex+scaled.length+scaled.altitude+I(scaled.altitude))

pValues <- doUnivariateTest(dfObs=observedDisease,dfSim=predictedDisease$t, fun=mean)




### ONLY for Proportions,i.e. glm with cbind(ill,N-ill) ###
frequencyObs  <- table(observedDisease)  / length(observedDisease)
frequencyPred <- table(predictedDisease) / length(predictedDisease)

combined <- rbind(c(frequencyObs, rep(NA,  (length(frequencyPred) - length(frequencyObs)))), frequencyPred) # empty frequencies


barplot(combined, beside = T)

plot(observedDisease,predictedDisease)
abline(c(0,0),c(1,1))


# residuals
sum(residuals(glm1, type = "pearson")^2)

residualsPearson<-residuals(model1, type = "pearson")
plot(observedDisease,residualsPearson)
abline(c(0,0),c(1,0))
```


Graphical visualisation of multivariate BN model using Lattice
```{r}
# extract coefficients
# coef(model1)
#     (Intercept)            sexw   scaled.length scaled.altitude 
#      -5.7365339       0.9464619      -0.4473926       0.3245303

sexmCoef      <- coef(model1)[1]
sexwCoef      <- coef(model1)[1]+coef(model1)[2]
lengthCoef    <- coef(model1)[3]
altitudeCoef  <- coef(model1)[4]
altitude2Coef <- coef(model1)[5]

library(lattice)
lattice.options(default.theme=col.whitebg)

sexCoef<-c(sexmCoef,sexwCoef) # Levels
sexName<-c("male","female")


# wireframe options
newcols <- colorRampPalette(c("grey90", "grey10")) # grid color

# defining the grid color scaling
# max(g$z)
# [1] 0.03812586



x<-model1$model$scaled.length
y<-model1$model$scaled.altitude

#g<-expand.grid(x=x,y=y)
g<-expand.grid(x=seq(-2,2,length.out=30),y=seq(-2,2,length.out=30))

for (s in 1:length(sexCoef)){
g$z<-1/(1+exp(-1*(
sexCoef[s] +  			    # intecept/ sex-category
lengthCoef*g$x +        # scaled length
altitudeCoef*g$y +			# scaled altitude
altitude2Coef*g$y*g$y  # bio12_worldclim.sq
)))

# screen to rotate 
fig<-wireframe(
z~x*y,g,
zoom = 0.8,
box=FALSE,
scales = list(arrows=FALSE,cex= 0.5, col = "black", font = 3),
zlim=c(0,0.025),
#at = do.breaks(0.05, 10),
#at=c( 0.0, 0.2, 0.6, 1.0),
at=seq(0,0.025,0.001),
#main=list(noquote(paste(shade.name[s],subsoil.coef.name[o],sep=" and ")),cex=0.8),
drape = TRUE,
col.regions = newcols(100),
colorkey = TRUE,
screen = list(z=225,x = -55),
#xlab=list(label=bquote(~"scaled"~italic("Hyalesthes obsoletus")~"body size (mm)"),cex= 0.5,rot=25),
lab=list(label=substitute(expression(paste(a," ",italic(b)," ",c)), list(a="Scaled",b="Hyalesthes obsoletus",c="body size (mm)")),cex= 0.8,rot=25),
lab=list(label=expression(~~"(Scaled altitude (m a.s.l.))"^2),cex= 0.8,rot=-25),
#ylab=list(label="Scaled altitude (m a.s.l.)",cex= 0.5,rot=-25),
lab=list(label= "Bois noir disease prevalence",cex= 0.8,rot=90),
shade=FALSE,
par.settings=list(background=list(col="transparent"))
)
#plot(fig)
assign(paste("fig.1",s,sep="."),fig)
}

# c(col,row,ncol,nrow)
trellis.par.set("axis.line",list(col=NA,lty=1,lwd=1)) # removes box
plot(fig.1.1,split=c(1,1,2,1))
plot(fig.1.2,split=c(2,1,2,1),newpage=FALSE)
```



```{r Reg_Dis_RelQuant}
df$disease.pred <- predict(model1,type="response")

ggplot(data=df, aes(x=scaled.rel_quant, y=disease.pred, group=sex, shape=sex,linetype=sex)) +  
  theme_bw()+
  geom_point() +
   stat_smooth(method = "glm",family="binomial", se=FALSE, color="black",) + 
   #stat_smooth(aes(x=scaled.length, y=phytoplasma),data=regDfPredicted,stat="identity") + 
  xlab(bquote(~"scaled "~italic("Ca.")~"Phytoplasma solani relative quantities")) + # Set x-axis label
  ylab(bquote(~"Bois noir disease incidence")) # Set x-axis label
```


# Session info
```{r, echo=FALSE}
devtools::session_info()
```
